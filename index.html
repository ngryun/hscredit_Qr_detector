<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PDF í•™ìƒ ì •ë³´ ì¶”ì¶œê¸° (ë¼ë²¨-í¬ë¡­ ë””ì½”ë”© ê°œì„ íŒ)</title>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
</script>

<!-- jsQR -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<style>
  :root { --primary:#3478f6; --bg:#f6f7fb; --card:#fff; --muted:#8b95a1; --ok:#22c55e; --warn:#f59e0b; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial,sans-serif;background:var(--bg);margin:0}
  .container{max-width:1200px;margin:0 auto;padding:24px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:28px}
  h1{margin:0 0 16px;font-size:22px}
  .upload{border:2px dashed var(--primary);border-radius:14px;padding:28px;text-align:center;background:#eef3ff;cursor:pointer}
  .upload.dragover{background:#e6f4ea;border-color:#22c55e}
  input[type=file]{display:none}
  .btn{background:var(--primary);color:#fff;border:0;border-radius:10px;padding:12px 18px;cursor:pointer;font-weight:600}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.secondary{background:#111827}
  .btn.ghost{background:#eef2f7;color:#111827}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;margin-top:12px}
  .progress{height:10px;background:#edf2ff;border-radius:99px;overflow:hidden;margin:14px 0;display:none}
  .progress>div{height:100%;width:0%;background:linear-gradient(90deg,#60a5fa,#6366f1);transition:width .25s ease}
  .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:18px 0}
  .stat{background:#111827;color:#fff;border-radius:12px;padding:16px}
  .stat .big{font-size:28px;font-weight:800}
  .hidden{display:none}
  .table-wrap{overflow:auto;border-radius:12px;border:1px solid #e5e7eb;background:#fff}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px 12px;border-bottom:1px solid #f1f5f9;text-align:left;vertical-align:top}
  th{background:#0f172a;color:#fff;position:sticky;top:0}
  tr:hover td{background:#fafafa}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .log{background:#0b1220;color:#d1d5db;border-radius:12px;padding:12px;height:220px;overflow:auto;white-space:pre-wrap;font-size:12px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#111827;font-size:12px}
  .ok{color:#16a34a}
  .warn{color:#d97706}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  canvas.debug{max-width:100%;border:1px solid #e5e7eb;border-radius:10px}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>ğŸ“„ PDF í•™ìƒ ì •ë³´ ì¶”ì¶œê¸° (ê³ ì •ë°€ ë¼ë²¨-í¬ë¡­ ë””ì½”ë”©)</h1>
    <div class="upload" id="drop" onclick="fileInput.click()">
      <div><strong>PDF íŒŒì¼ì„ ì„ íƒ</strong>í•˜ê±°ë‚˜ ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”.</div>
      <div class="muted">í•™ë²ˆÂ·ì´ë¦„ í…ìŠ¤íŠ¸ì™€ QRì´ ê°™ì€ ê²©ìë¡œ ë°°ì¹˜ëœ PDFì— ìµœì í™”</div>
      <input id="fileInput" type="file" accept="application/pdf"/>
    </div>

    <div class="row">
      <button id="run" class="btn" disabled>ë°ì´í„° ì¶”ì¶œ</button>
      <button id="toggleLog" class="btn ghost">ë¡œê·¸ ë³´ê¸°</button>
      <button id="toggleDebug" class="btn ghost">ë””ë²„ê·¸ ìº”ë²„ìŠ¤</button>
    </div>

    <div class="progress" id="prog"><div id="bar"></div></div>

    <div id="debugWrap" class="hidden grid">
      <div>
        <div class="pill mono">ë Œë” ìº”ë²„ìŠ¤</div>
        <canvas id="pageCanvas" class="debug"></canvas>
      </div>
      <div>
        <div class="pill mono">í¬ë¡­ ë¯¸ë¦¬ë³´ê¸°</div>
        <canvas id="cropCanvas" class="debug"></canvas>
      </div>
    </div>

    <div id="log" class="log hidden"></div>

    <div id="results" class="hidden">
      <div class="stats">
        <div class="stat"><div class="big" id="statTotal">0</div>ì´ í•™ìƒ ìˆ˜</div>
        <div class="stat"><div class="big" id="statUrls">0</div>QR ë””ì½”ë”© ì„±ê³µ</div>
        <div class="stat"><div class="big" id="statTime">0</div>ì²˜ë¦¬ ì‹œê°„(ì´ˆ)</div>
      </div>

      <div class="row">
        <button class="btn secondary" id="exportCSV">CSVë¡œ ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn secondary" id="exportJSON">JSONìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°</button>
      </div>

      <div class="table-wrap" style="margin-top:12px">
        <table id="table">
          <thead>
            <tr>
              <th style="width:80px">ë²ˆí˜¸</th>
              <th style="width:120px">í•™ë²ˆ</th>
              <th style="width:120px">ì´ë¦„</th>
              <th>QR URL</th>
              <th style="width:90px">í˜ì´ì§€</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

let selectedFile = null;
let extracted = [];

const logEl = $('#log');
const prog = $('#prog'); const bar = $('#bar');

function log(msg){
  const t = new Date().toLocaleTimeString();
  logEl.textContent += `[${t}] ${msg}\n`;
  logEl.scrollTop = logEl.scrollHeight;
  console.log(msg);
}

function setProgress(p){
  prog.style.display = 'block';
  bar.style.width = `${p}%`;
  if (p >= 100) setTimeout(()=>prog.style.display='none', 800);
}

// --- ë“œë˜ê·¸&ë“œë¡­ / íŒŒì¼ ì„ íƒ ---
const drop = $('#drop');
const fileInput = $('#fileInput');
drop.addEventListener('dragover', e=>{e.preventDefault(); drop.classList.add('dragover')});
drop.addEventListener('dragleave', ()=>drop.classList.remove('dragover'));
drop.addEventListener('drop', e=>{
  e.preventDefault(); drop.classList.remove('dragover');
  const f = e.dataTransfer.files?.[0];
  if (f && f.type === 'application/pdf'){ selectedFile = f; $('#run').disabled = false; drop.innerHTML = `âœ… ${f.name}`; log(`ì„ íƒ: ${f.name} ${(f.size/1024/1024).toFixed(2)} MB`) }
});

fileInput.addEventListener('change', e=>{
  const f = e.target.files?.[0];
  if (f && f.type === 'application/pdf'){ selectedFile = f; $('#run').disabled = false; drop.innerHTML = `âœ… ${f.name}`; log(`ì„ íƒ: ${f.name} ${(f.size/1024/1024).toFixed(2)} MB`) }
});

$('#toggleLog').onclick=()=> logEl.classList.toggle('hidden');
$('#toggleDebug').onclick=()=> $('#debugWrap').classList.toggle('hidden');

// --- ì¢Œí‘œ/í…ìŠ¤íŠ¸ ìœ í‹¸ ---
function pdfToCanvasPoint(x, y, viewport){
  const m = viewport.transform; // [a,b,c,d,e,f]
  return { x: x * m[0] + m[4], y: y * m[3] + m[5] };
}

// ë¼ë²¨(í•™ë²ˆ+ì´ë¦„) ì°¾ê¸°: ê°™ì€ ë¼ì¸ì˜ ë‘ í† í° ë¶™ì´ê¸°
function groupStudentLabels(textItems, viewport){
  // token í›„ë³´: í•™ë²ˆ(5ìë¦¬) ë˜ëŠ” ê³µë°± ì—†ëŠ” ë¬¸ìì—´
  const isId = s => /^\d{5}$/.test(s);
  const isName = s => /^\S+$/.test(s);

  const tokens = textItems
    .map(it=>({ text: it.str.trim(), x: it.transform[4], y: it.transform[5] }))
    .filter(it=> isId(it.text) || isName(it.text));

  // yê¸°ì¤€ìœ¼ë¡œ ì¤„ ë¬¶ê¸°(ê°€ê¹Œìš´ yëŠ” ê°™ì€ ë¼ì¸)
  tokens.sort((a,b)=> b.y - a.y);
  const lines=[]; const tolY=3;
  tokens.forEach(t=>{
    const line = lines.find(L => Math.abs(L.y - t.y) < tolY);
    if (line){ line.items.push(t); line.y=(line.y+t.y)/2 }
    else lines.push({ y:t.y, items:[t] });
  });

  const labels=[];
  lines.forEach(L=>{
    L.items.sort((a,b)=> a.x - b.x);
    for (let i=0;i<L.items.length-1;i++){
      const A=L.items[i], B=L.items[i+1];
      if (isId(A.text) && !isId(B.text) && isName(B.text)){
        const pA = pdfToCanvasPoint(A.x,A.y,viewport);
        const pB = pdfToCanvasPoint(B.x,B.y,viewport);
        const x0=Math.min(pA.x,pB.x), x1=Math.max(pA.x,pB.x);
        const y0=Math.min(pA.y,pB.y), y1=Math.max(pA.y,pB.y);
        labels.push({
          sid:A.text, name:B.text,
          bbox:{x0,y0,x1,y1}, cx:(x0+x1)/2, cy:(y0+y1)/2
        });
      }
    }
  });

  return labels;
}

// ìº”ë²„ìŠ¤ì—ì„œ ë¼ë²¨ ì•„ë˜ ì˜ì—­ì„ í¬ë¡­(ì •ì‚¬ê°)
function cropBelowLabel(ctx, label, opts){
  const { padX=40, padY=12, size=260, clampW, clampH } = opts || {};
  let x = Math.max(0, Math.round(label.bbox.x0 - padX));
  let y = Math.max(0, Math.round(label.bbox.y1 + padY));
  const w = Math.min(size, clampW - x);
  const h = Math.min(size, clampH - y);
  if (w <= 10 || h <= 10) return null;
  const img = ctx.getImageData(x,y,w,h);
  return { img, x, y, w, h };
}

// ê°„ë‹¨í•œ ì´ì§„í™”ë¡œ ëŒ€ë¹„ í–¥ìƒ
function binarize(imgData, thr){
  const d = imgData.data;
  for (let i=0;i<d.length;i+=4){
    const v = (d[i] + d[i+1] + d[i+2]) / 3;
    const b = v > thr ? 255 : 0;
    d[i]=d[i+1]=d[i+2]=b;
  }
  return imgData;
}

function decodeWithJsQR(imgData){
  const code = jsQR(imgData.data, imgData.width, imgData.height, { inversionAttempts:"attemptBoth" });
  return code?.data || "";
}

// ì‹¤íŒ¨ ë¼ë²¨ë§Œ ì¬ì‹œë„(ìŠ¤ì¼€ì¼ ì—… + ë‹¤ë¥¸ ì„ê³„ê°’)
async function retryFailed(page, viewportBase, failed, baseScale){
  const scales = [baseScale*1.5, baseScale*2.0];
  const thresholds = [128, 160, 100];

  for (const scale of scales){
    const viewport = page.getViewport({ scale });
    // ë Œë” 1íšŒ
    const cvs=document.createElement('canvas'), ctx=cvs.getContext('2d');
    cvs.width=viewport.width; cvs.height=viewport.height;
    await page.render({ canvasContext:ctx, viewport }).promise;

    for (const f of failed.filter(x=>!x.decoded)){
      const labelScaled = {
        bbox:{
          x0: f.label.bbox.x0 * (scale/baseScale),
          y0: f.label.bbox.y0 * (scale/baseScale),
          x1: f.label.bbox.x1 * (scale/baseScale),
          y1: f.label.bbox.y1 * (scale/baseScale),
        }
      };
      const crop = cropBelowLabel(ctx, labelScaled, { size: 320, padX: 50, padY: 16, clampW:cvs.width, clampH:cvs.height });
      if (!crop) continue;

      // ì„ê³„ê°’ ì—¬ëŸ¬ ê°œë¡œ ì‹œë„
      let out = decodeWithJsQR(crop.img);
      if (!out){
        for (const thr of thresholds){
          const bin = new ImageData(new Uint8ClampedArray(crop.img.data), crop.img.width, crop.img.height);
          binarize(bin, thr);
          out = decodeWithJsQR(bin);
          if (out) break;
        }
      }
      if (out) f.decoded = out;
    }
    // ëª¨ë‘ í•´ê²°ëìœ¼ë©´ ì¡°ê¸° ì¢…ë£Œ
    if (failed.every(x=>x.decoded)) break;
  }
}

// ë©”ì¸ ì¶”ì¶œ
async function extract(){
  if (!selectedFile){ alert('PDF íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.'); return; }
  $('#run').disabled = true; extracted = []; $('#results').classList.add('hidden');
  const t0 = performance.now();
  try{
    log('ë¬¸ì„œ ë¡œë”©â€¦');
    const buf = await selectedFile.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data:buf }).promise;
    log(`ì´ ${pdf.numPages} í˜ì´ì§€`);

    let total=0, okCount=0;

    for (let pn=1; pn<=pdf.numPages; pn++){
      setProgress( (pn-1)/pdf.numPages*90 );
      log(`\nâ–¶ í˜ì´ì§€ ${pn} ì²˜ë¦¬ ì‹œì‘`);

      const page = await pdf.getPage(pn);
      const baseScale = 2.0;
      const viewport = page.getViewport({ scale: baseScale });

      // ë Œë” 1íšŒ
      const pageCanvas = $('#pageCanvas'), pctx = pageCanvas.getContext('2d');
      pageCanvas.width = viewport.width; pageCanvas.height = viewport.height;
      await page.render({ canvasContext: pctx, viewport }).promise;

      // í…ìŠ¤íŠ¸ â†’ ë¼ë²¨(í•™ë²ˆ+ì´ë¦„) ì¶”ì¶œ
      const text = await page.getTextContent();
      const labels = groupStudentLabels(text.items, viewport);
      log(`ë¼ë²¨ ê°ì§€: ${labels.length}ê°œ`);

      // ë¼ë²¨ë³„ í¬ë¡­ í›„ jsQR ë””ì½”ë”©
      const failed = [];
      for (const label of labels){
        const crop = cropBelowLabel(pctx, label, { clampW: pageCanvas.width, clampH: pageCanvas.height });
        let decoded = "";
        if (crop){
          // ì›ë³¸
          decoded = decodeWithJsQR(crop.img);
          // ì‹¤íŒ¨ ì‹œ ì´ì§„í™” ë¹ ë¥¸ ì¬ì‹œë„(í•œ ë²ˆ)
          if (!decoded){
            const bin = new ImageData(new Uint8ClampedArray(crop.img.data), crop.img.width, crop.img.height);
            binarize(bin, 140);
            decoded = decodeWithJsQR(bin);
          }

          // ë””ë²„ê·¸: ì²« í˜ì´ì§€ ì¼ë¶€ í¬ë¡­ ë¯¸ë¦¬ë³´ê¸°
          if (pn===1 && total<3){
            const c = $('#cropCanvas'), cctx = c.getContext('2d');
            c.width=crop.w; c.height=crop.h; cctx.putImageData(crop.img,0,0);
          }
        }

        if (!decoded){
          failed.push({ label, decoded:"" });
        }else{
          okCount++;
        }

        extracted.push({ ë²ˆí˜¸: ++total, í•™ë²ˆ: label.sid, ì´ë¦„: label.name, QR_URL: decoded || "", í˜ì´ì§€: pn });
      }

      // ì‹¤íŒ¨ ë¼ë²¨ë§Œ ìŠ¤ì¼€ì¼ì—…/ë‹¤ì¤‘ ì„ê³„ê°’ìœ¼ë¡œ ì¬ì‹œë„
      if (failed.length){
        log(`ì¬ì‹œë„ ëŒ€ìƒ: ${failed.length}ê°œ (ìŠ¤ì¼€ì¼ì—…/ì´ì§„í™”)`);
        await retryFailed(page, viewport, failed, baseScale);

        // ë°˜ì˜
        for (const f of failed){
          if (f.decoded){
            okCount++;
            const row = extracted.find(r => r.í˜ì´ì§€===pn && r.í•™ë²ˆ===f.label.sid && r.ì´ë¦„===f.label.name);
            if (row) row.QR_URL = f.decoded;
          }
        }
      }

      log(`í˜ì´ì§€ ${pn} ì™„ë£Œ â¯ ì„±ê³µ: ${extracted.filter(x=>x.í˜ì´ì§€===pn && x.QR_URL).length} / ë¼ë²¨: ${labels.length}`);
    }

    setProgress(100);

    // ê²°ê³¼ í‘œì‹œ
    $('#results').classList.remove('hidden');
    $('#statTotal').textContent = extracted.length;
    $('#statUrls').textContent = extracted.filter(r=>r.QR_URL).length;
    $('#statTime').textContent = ((performance.now()-t0)/1000).toFixed(2);

    const tbody = $('#tbody'); tbody.innerHTML = "";
    for (const r of extracted){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.ë²ˆí˜¸}</td>
        <td class="mono">${r.í•™ë²ˆ}</td>
        <td>${r.ì´ë¦„}</td>
        <td>${r.QR_URL ? `<a href="${r.QR_URL}" target="_blank" class="mono">${r.QR_URL}</a>` : '<span class="muted">-</span>'}</td>
        <td>${r.í˜ì´ì§€}</td>
      `;
      tbody.appendChild(tr);
    }

    log(`\nâœ… ì „ì²´ ì™„ë£Œ: ì´ ${extracted.length}ëª…, ë””ì½”ë”© ${extracted.filter(r=>r.QR_URL).length}ê±´`);

  }catch(err){
    console.error(err);
    log(`âŒ ì˜¤ë¥˜: ${err.message}`);
    alert(`ì˜¤ë¥˜: ${err.message}`);
  }finally{
    $('#run').disabled = false;
  }
}

// --- ë‚´ë³´ë‚´ê¸° ---
function exportCSV(){
  if (!extracted.length) return alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
  const headers = ['ë²ˆí˜¸','í•™ë²ˆ','ì´ë¦„','QR_URL','í˜ì´ì§€'];
  const rows = extracted.map(r => `${r.ë²ˆí˜¸},${r.í•™ë²ˆ},${r.ì´ë¦„},"${r.QR_URL||''}",${r.í˜ì´ì§€}`);
  const blob = new Blob(['\uFEFF'+[headers.join(','), ...rows].join('\n')], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download = `í•™ìƒì •ë³´_${new Date().toISOString().slice(0,10)}.csv`; a.click();
}
function exportJSON(){
  if (!extracted.length) return alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
  const blob = new Blob([JSON.stringify(extracted,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download = `í•™ìƒì •ë³´_${new Date().toISOString().slice(0,10)}.json`; a.click();
}

// --- ë°”ì¸ë”© ---
$('#run').onclick = extract;
$('#exportCSV').onclick = exportCSV;
$('#exportJSON').onclick = exportJSON;

// ì´ˆê¸° ë¡œê·¸
document.addEventListener('DOMContentLoaded', ()=>{
  log('ğŸš€ ë¡œë“œ ì™„ë£Œ: PDF.js + jsQR');
  log('â„¹ï¸ ë¼ë²¨(í•™ë²ˆ+ì´ë¦„) ì•„ë˜ë§Œ í¬ë¡­í•˜ì—¬ jsQRë¡œ ë””ì½”ë”©í•©ë‹ˆë‹¤.');
});
</script>
</body>
</html>
